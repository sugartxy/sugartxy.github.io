<!DOCTYPE html>
<html lang="">
<head>
  <meta charset="UTF-8">
<meta name="google-site-verification" content="clAZuIjGfpjQ_nPuiZ6yQtUblRGcpNDfzl1sCL7BSFY" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"xinyeah.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null,"activeClass":"gitalk"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="A stateful structured stream processing job is suddenly stuck at the 1st micro-batch job. Here are the notes about that issue, how to debug Spark stateful streaming job, and also how I fix it.">
<meta property="og:type" content="article">
<meta property="og:title" content="Spark stateful streaming processing is stuck in StateStoreSave stage!">
<meta property="og:url" content="https://xinyeah.github.io/Spark-stateful-streaming-processing-is-stuck-in-StateStoreSave-stage/index.html">
<meta property="og:site_name" content="TangTalk - Tech Blog">
<meta property="og:description" content="A stateful structured stream processing job is suddenly stuck at the 1st micro-batch job. Here are the notes about that issue, how to debug Spark stateful streaming job, and also how I fix it.">
<meta property="og:image" content="https://raw.githubusercontent.com/xinyeah/xinyeah.github.io/master/images/image-20200706163510103.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xinyeah/xinyeah.github.io/master/images/image-20200706171557385.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xinyeah/xinyeah.github.io/master/images/image-20200706171822384.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xinyeah/xinyeah.github.io/master/images/image-20200706172128040.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xinyeah/xinyeah.github.io/master/images/image-20200706172305651.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xinyeah/xinyeah.github.io/master/images/image-20200706161548770.png">
<meta property="article:published_time" content="2020-07-07T20:46:59.000Z">
<meta property="article:modified_time" content="2020-09-23T00:46:23.740Z">
<meta property="article:author" content="Xinye">
<meta property="article:tag" content="Spark">
<meta property="article:tag" content="Databricks">
<meta property="article:tag" content="Stream processing">
<meta property="article:tag" content="Azure Blob Storage">
<meta property="article:tag" content="Azure Data Lake Storage Gen2">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/xinyeah/xinyeah.github.io/master/images/image-20200706163510103.png">

<link rel="canonical" href="https://xinyeah.github.io/Spark-stateful-streaming-processing-is-stuck-in-StateStoreSave-stage/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'default'
  };
</script>

  <title>Spark stateful streaming processing is stuck in StateStoreSave stage! | TangTalk - Tech Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="TangTalk - Tech Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>
	
	<a href="https://github.com/xinyeah" target="_blank" rel="noopener" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#70B7FD; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">TangTalk - Tech Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">future architect's daily life</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="https://xinyeah.github.io/Spark-stateful-streaming-processing-is-stuck-in-StateStoreSave-stage/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/tang.jpg">
      <meta itemprop="name" content="Xinye">
      <meta itemprop="description" content="Let us make this fairy tale true, and forever">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TangTalk - Tech Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Spark stateful streaming processing is stuck in StateStoreSave stage!
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-07-07 20:46:59" itemprop="dateCreated datePublished" datetime="2020-07-07T20:46:59+00:00">2020-07-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-09-23 00:46:23" itemprop="dateModified" datetime="2020-09-23T00:46:23+00:00">2020-09-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spark/" itemprop="url" rel="index"><span itemprop="name">Spark</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
            <div class="post-description">A stateful structured stream processing job is suddenly stuck at the 1st micro-batch job. Here are the notes about that issue, how to debug Spark stateful streaming job, and also how I fix it.</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Spark-stateful-streaming-processing-is-stuck-in-StateStoreSave-stage"><a href="#Spark-stateful-streaming-processing-is-stuck-in-StateStoreSave-stage" class="headerlink" title="Spark stateful streaming processing is stuck in StateStoreSave stage!"></a>Spark stateful streaming processing is stuck in StateStoreSave stage!</h1><p>A stateful structured stream processing job is suddenly stuck at the 1st micro-batch job. Here are the notes about that issue, how to debug Spark stateful streaming job, and also how I fix it.</p>
<h2 id="Stateful-Structured-Streaming-Processing-Job"><a href="#Stateful-Structured-Streaming-Processing-Job" class="headerlink" title="Stateful Structured Streaming Processing Job"></a>Stateful Structured Streaming Processing Job</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">## specify data source, read data from Azure Event Hub</span></span><br><span class="line">(spark.readStream.format(<span class="string">"eventhubs"</span>) </span><br><span class="line"> .options(**self.config.ehConfig)</span><br><span class="line"> .load()  </span><br><span class="line"> <span class="comment">## use watermark to control state size</span></span><br><span class="line"> .withWatermark(processTimeCol, waterMarkTime)</span><br><span class="line"> <span class="comment">## transformations. </span></span><br><span class="line"> .withColumn(eventTimeCol, col(eventTimeCol).cast(<span class="string">'timestamp'</span>))</span><br><span class="line"> <span class="comment">## aggregation by event time windows</span></span><br><span class="line"> .groupBy(col(key), window(eventTimeCol, <span class="string">"15 mins"</span>))</span><br><span class="line"> .agg()</span><br><span class="line"> ...</span><br><span class="line"> .select(*(cols+[<span class="string">'windowStart'</span>, <span class="string">'firstEventTime'</span>, <span class="string">'lastEventTime'</span>, <span class="string">'count'</span>]))</span><br><span class="line"> <span class="comment">## specify data sink, write transformed output to Azure blob storage</span></span><br><span class="line"> .writeStream</span><br><span class="line"> .format(<span class="string">"parquet"</span>)</span><br><span class="line"> .option(<span class="string">'path'</span>, outputPath)</span><br><span class="line"> .outputMode(<span class="string">"append"</span>)</span><br><span class="line"> <span class="comment">## Processing details--Trigger: when to process data</span></span><br><span class="line"> .trigger(processingTime=<span class="string">"2 seconds"</span>)  </span><br><span class="line"> <span class="comment">## Processing details--Checkpoint: for tracking the progress of the query</span></span><br><span class="line"> .option(<span class="string">"checkpointLocation"</span>, checkpointPath)</span><br><span class="line"> .start())</span><br></pre></td></tr></table></figure>

<p>Spark SQL converts batch-like query to a series of incremental execution plans operating on new micro-batches of data.</p>
<p><img src="https://raw.githubusercontent.com/xinyeah/xinyeah.github.io/master/images/image-20200706163510103.png" alt="image-20200706163510103"></p>
<h2 id="Environment"><a href="#Environment" class="headerlink" title="Environment"></a>Environment</h2><p>This Streaming job is running on <strong>Databricks</strong> clusters triggered by <strong>Azure Data Factory</strong> pipeline.</p>
<p>Data source is from <strong>Azure Event Hub</strong>, and this job store the aggregated output to <strong>Azure Blob Storage</strong> mounted on <strong>Databricks</strong>.</p>
<p><strong>Databricks</strong> instance has <strong>Vnet injections</strong> and have <strong>NSG</strong> associated with the Vnet.</p>
<p>Databricks cluster version is 5.5 LTS which use <strong>Scala</strong> 2.11, <strong>Spark</strong> 2.4.3 and <strong>Python</strong> 3. </p>
<p>We also use <strong>PySpark</strong> 2.4.4 for this streaming job.</p>
<h2 id="Issue-Symptom"><a href="#Issue-Symptom" class="headerlink" title="Issue Symptom"></a>Issue Symptom</h2><p>This streaming job is scheduled to run for 4 hours every time. When the current job stops, the next one will start to run. It means the max number of concurrency job is 1. </p>
<p>It was running well before. Suddenly, when a new streaming job starts, it seems to stuck at the 1st micro-batch like the following picture. You can see the job is stuck for batch=0 and it fails because of time out.</p>
<p>We have 3 regions and this issue happened to every region one by one in a week.</p>
<p><img src="https://raw.githubusercontent.com/xinyeah/xinyeah.github.io/master/images/image-20200706171557385.png" alt="image-20200706171557385"></p>
<p><img src="https://raw.githubusercontent.com/xinyeah/xinyeah.github.io/master/images/image-20200706171822384.png" alt="image-20200706171822384"></p>
<p>If you check the checkpoint folder:</p>
<p><img src="https://raw.githubusercontent.com/xinyeah/xinyeah.github.io/master/images/image-20200706172128040.png" alt="image-20200706172128040"></p>
<p>compare with the normal checkpoint:</p>
<p><img src="https://raw.githubusercontent.com/xinyeah/xinyeah.github.io/master/images/image-20200706172305651.png" alt="image-20200706172305651"></p>
<p>The difference is obvious: there is no commits in the checkpoint path. It means the streaming job didn’t succeed in processing even a single micro-batch.</p>
<h2 id="Possible-Causes"><a href="#Possible-Causes" class="headerlink" title="Possible Causes"></a>Possible Causes</h2><p>It is really tough to debug this issue because no error message shown up and just several misleading warning messages in the executor’s error logs.</p>
<p>Usually, there are several possible reasons to cause streaming processing job stuck, such as:</p>
<ul>
<li><p><strong>Total size of state per worker</strong> is too large which leads to higher overheads of snapshotting and JVM GC pauses.</p>
</li>
<li><p><strong>Number of shuffle partitions</strong> is too high, so the cost of writing state to HDFS will increase which cause the higher latency.</p>
</li>
<li><p><strong>NSG rules</strong> added to Databricks Vnet might block some ports and thus infect worker to worker communication.</p>
</li>
<li><p><strong>Databricks mounted blobs are expired</strong> and need to rotate the storage connection string and databricks access token.</p>
</li>
<li><p><strong>Databricks cluster version</strong> is deprecated and not supported any more.</p>
</li>
<li><p><strong>Spark .metadata directory</strong> is messed up. We need to delete the metadata and let the pipeline recreate a new one. but for this one, it would complete micro-batch, and it just do nothing in the process.</p>
</li>
</ul>
<p>  But <strong>none of them work</strong> this time. We struggle to figure out the <strong>root cause</strong> is:</p>
<ul>
<li><strong>Azure blob storage has too many files in the checkpoint folder</strong> which slow down the read and write speed. </li>
</ul>
<p>I compare the DAG visualization with normal job’s, it is shown that the StateStoreSave stage takes much longer (16 hours) than the normal one (21 seconds). StateStoreSave is the stage when spark store current streaming process status in checkpoint. Thus the issue exists in checkpoints. More info for StateStoreSave can be found <a href="https://jaceklaskowski.gitbooks.io/spark-structured-streaming/spark-sql-streaming-StateStoreSaveExec.html" target="_blank" rel="noopener">here</a></p>
<p><img src="https://raw.githubusercontent.com/xinyeah/xinyeah.github.io/master/images/image-20200706161548770.png" alt="image-20200706161548770"></p>
<p>From this detailed stage information, we can get:</p>
<ol>
<li><p><strong>number of total state rows</strong> is not the concern. we cannot solve the issue by reduce the watermark threshold or recreate checkpoint.</p>
</li>
<li><p><strong>memory used by state total</strong> is lower than the normal state. so it is not a JVM GC pause issue.</p>
</li>
<li><p><strong>time to update total</strong> is the pain point. It takes longer even the number of updated state rows is less, which point the issue to the <strong>write speed</strong> in blob storage. </p>
<p>In the checkpoint folder, we stored around 17 million checkpoints for each region. After I delete the whole checkpoint folder and restart the streaming job, the issue is fixed. I am not 100% sure about the reason for it. One possible reason for it is Azure blob storage doesn’t support <strong>hierarchical namespace</strong>, and it just mimic hierarchical directory structure by using slashes in the name. </p>
</li>
</ol>
<h2 id="Solutions"><a href="#Solutions" class="headerlink" title="Solutions"></a>Solutions</h2><h3 id="Solution-1-migrate-Azure-blob-storage-to-Azure-Data-Lake-Gen2-which-supports-hierarchical-namespace"><a href="#Solution-1-migrate-Azure-blob-storage-to-Azure-Data-Lake-Gen2-which-supports-hierarchical-namespace" class="headerlink" title="Solution 1 - migrate Azure blob storage to Azure Data Lake Gen2 which supports hierarchical namespace."></a>Solution 1 - migrate Azure blob storage to Azure Data Lake Gen2 which supports hierarchical namespace.</h3><h3 id="Solution-2-delete-checkpoint-folder-and-decrease-retention-period"><a href="#Solution-2-delete-checkpoint-folder-and-decrease-retention-period" class="headerlink" title="Solution 2 - delete checkpoint folder and decrease retention period."></a>Solution 2 - delete checkpoint folder and decrease retention period.</h3><p>Step1: Stop current streaming job</p>
<p>Step2: Delete .metadata directory and checkpoint folder</p>
<p>Step3: Add a failover mechanism so that the streaming job will resume from where the streaming job stopped in the last successful data persistence.</p>
<p>Here is my failover mechanism if no checkpoint found, so we can delete the checkpoint folder without losing state.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">       <span class="comment"># if the checkpoint exists, continue to use it without refreshing</span></span><br><span class="line">       config.dbutils.fs.ls(config.checkpointPath)</span><br><span class="line">       print(<span class="string">'Continue streaming job with checkpoint path, %s'</span> %</span><br><span class="line">             config.checkpointPath)</span><br><span class="line">   <span class="keyword">except</span>:</span><br><span class="line">       <span class="comment"># remove _spark_metadata folder when use a new checkpoint</span></span><br><span class="line">       config.dbutils.fs.rm(config.outputPath + <span class="string">'_spark_metadata'</span>, <span class="literal">True</span>)</span><br><span class="line">       print(<span class="string">'removed _spark_metadata for last checkpoint'</span>)</span><br><span class="line">       print(<span class="string">'New streaming job checkpoint path is %s'</span> %</span><br><span class="line">             config.checkpointPath)</span><br><span class="line">       <span class="comment"># set the streaming start time to catch up from where the streaming job stoped in last data persistence</span></span><br><span class="line">       timeKey = <span class="string">'windowStart'</span></span><br><span class="line">       <span class="keyword">try</span>:</span><br><span class="line">           ts = [int(p.path.split(timeKey + <span class="string">"="</span>)[<span class="number">1</span>][:<span class="number">-1</span>])</span><br><span class="line">                 <span class="keyword">for</span> p <span class="keyword">in</span> config.dbutils.fs.ls(config.outputPath) <span class="keyword">if</span> timeKey <span class="keyword">in</span> p.path]</span><br><span class="line">           <span class="keyword">if</span> ts:</span><br><span class="line">               lookbackTs = int(dt.datetime.now().replace(minute=<span class="number">0</span>, second=<span class="number">0</span>, microsecond=<span class="number">0</span>).timestamp()) - defualtLookbackTime</span><br><span class="line">               <span class="comment"># Set stream start time to the maximum of (15min aggregation output timestamp or one day back from current time)</span></span><br><span class="line">               streamStartTime = np.max([np.max(ts), lookbackTs])</span><br><span class="line">               <span class="comment"># Add 15min to start time</span></span><br><span class="line">               streamStartTime = dt.datetime.fromtimestamp(</span><br><span class="line">                   streamStartTime) + dt.timedelta(minutes=<span class="number">15</span>)</span><br><span class="line">               streamStartTime = streamStartTime.strftime(<span class="string">"%Y-%m-%dT%H:%M:%S.%fZ"</span>)</span><br><span class="line">               <span class="comment"># Create the positions</span></span><br><span class="line">               startingEventPosition = &#123;</span><br><span class="line">                   <span class="string">"offset"</span>: <span class="literal">None</span>,</span><br><span class="line">                   <span class="string">"seqNo"</span>: <span class="number">-1</span>,</span><br><span class="line">                   <span class="string">"enqueuedTime"</span>: streamStartTime,</span><br><span class="line">                   <span class="string">"isInclusive"</span>: <span class="literal">True</span></span><br><span class="line">               &#125;</span><br><span class="line">               config.ehConfig[<span class="string">"eventhubs.startingPosition"</span>] = json.dumps(</span><br><span class="line">                   startingEventPosition)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">           <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>Step 4: restart the streaming job.</p>
<p>Step 5: Add retention policy to the checkpoint folder to decrease the checkpoints lifetime.</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Spark/" rel="tag"># Spark</a>
              <a href="/tags/Databricks/" rel="tag"># Databricks</a>
              <a href="/tags/Stream-processing/" rel="tag"># Stream processing</a>
              <a href="/tags/Azure-Blob-Storage/" rel="tag"># Azure Blob Storage</a>
              <a href="/tags/Azure-Data-Lake-Storage-Gen2/" rel="tag"># Azure Data Lake Storage Gen2</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/databricks-migration-guide/" rel="prev" title="Databricks Migration Guide">
      <i class="fa fa-chevron-left"></i> Databricks Migration Guide
    </a></div>
      <div class="post-nav-item">
    <a href="/Azure-Certifications-and-Exams/" rel="next" title="Azure Certifications and Exams">
      Azure Certifications and Exams <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Spark-stateful-streaming-processing-is-stuck-in-StateStoreSave-stage"><span class="nav-text">Spark stateful streaming processing is stuck in StateStoreSave stage!</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Stateful-Structured-Streaming-Processing-Job"><span class="nav-text">Stateful Structured Streaming Processing Job</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Environment"><span class="nav-text">Environment</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Issue-Symptom"><span class="nav-text">Issue Symptom</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Possible-Causes"><span class="nav-text">Possible Causes</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Solutions"><span class="nav-text">Solutions</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Solution-1-migrate-Azure-blob-storage-to-Azure-Data-Lake-Gen2-which-supports-hierarchical-namespace"><span class="nav-text">Solution 1 - migrate Azure blob storage to Azure Data Lake Gen2 which supports hierarchical namespace.</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Solution-2-delete-checkpoint-folder-and-decrease-retention-period"><span class="nav-text">Solution 2 - delete checkpoint folder and decrease retention period.</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Xinye"
      src="/images/tang.jpg">
  <p class="site-author-name" itemprop="name">Xinye</p>
  <div class="site-description" itemprop="description">Let us make this fairy tale true, and forever</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">8</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">24</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Xinye</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '4a7822865a217c9ef426',
      clientSecret: '1b9bd25d4d3a1e122c34a8dee4e7ff53013784e3',
      repo        : 'gitalk',
      owner       : 'xinyeah',
      admin       : ['xinyeah'],
      id          : 'c71c3375b4c4a23400e388bb011ce23f',
        language: '',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
